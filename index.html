<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معرض فيديوهات مع زر احتياطي</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
        }
        .video-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        video::-webkit-media-controls { display: none !important; }
        video { pointer-events: none; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.15);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .video-card {
            break-inside: avoid;
            margin-bottom: 1rem;
            background-color: #1C1C1C;
        }
    </style>
</head>
<body class="antialiased">
    <main class="min-h-screen w-full p-4 sm:p-6">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">معرض الفيديوهات</h1>
            <p id="status-message" class="text-gray-400 mt-2">جاري تحميل الفيديوهات من المصدر...</p>
        </header>

        <div id="links-grid" class="columns-1 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-5 gap-4">
            <!-- سيتم إضافة بطاقات الفيديو هنا -->
        </div>

        <div id="load-more-container" class="text-center mt-8">
            <button id="load-more-btn" class="hidden bg-white text-black font-bold py-3 px-8 rounded-lg hover:bg-gray-300 transition-colors duration-300">
                تحميل المزيد
            </button>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const linksGrid = document.getElementById('links-grid');
        const statusMessage = document.getElementById('status-message');
        const loadMoreBtn = document.getElementById('load-more-btn');

        let allVideoUrls = [];
        let currentIndex = 0;
        const initialLoadSize = 10;
        const batchSize = 5;
        const fileUrl = 'https://raw.githubusercontent.com/Aminoxdag/My-links/refs/heads/main/pomfblackedfull.txt';

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function fetchAndInitialize() {
            try {
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error(`!فشل الاتصال بالشبكة: ${response.status}`);
                
                const text = await response.text();
                const urls = text.split('\n').filter(url => url.trim() !== '');
                
                allVideoUrls = shuffleArray(urls);

                if (allVideoUrls.length === 0) {
                    statusMessage.textContent = 'لم يتم العثور على فيديوهات.';
                    return;
                }
                
                statusMessage.textContent = `تم العثور على ${allVideoUrls.length} فيديو.`;
                loadMoreVideos(initialLoadSize);

                if (currentIndex < allVideoUrls.length) {
                    loadMoreBtn.classList.remove('hidden');
                }
            } catch (error) {
                statusMessage.textContent = `فشل تحميل القائمة. ${error.message}`;
                statusMessage.classList.add('text-red-500');
            }
        }

        function loadMoreVideos(count) {
            const batch = allVideoUrls.slice(currentIndex, currentIndex + count);
            batch.forEach(url => {
                const card = createLinkCard(url);
                linksGrid.appendChild(card);
            });
            currentIndex += count;

            if (currentIndex >= allVideoUrls.length) {
                loadMoreBtn.classList.add('hidden');
            }
        }
        
        loadMoreBtn.addEventListener('click', () => loadMoreVideos(batchSize));

        function createLinkCard(url) {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'video-card relative rounded-lg overflow-hidden shadow-lg group';
            
            const video = document.createElement('video');
            video.className = 'video-thumbnail transition-opacity duration-500 opacity-0';
            const randomThumbnailTime = Math.floor(Math.random() * 59) + 1;
            video.src = `${url}#t=${randomThumbnailTime}`;
            video.muted = true;
            video.playsInline = true;
            video.preload = 'metadata';

            const feedbackContainer = document.createElement('div');
            feedbackContainer.className = 'absolute inset-0 flex items-center justify-center p-2';
            feedbackContainer.innerHTML = `<div class="spinner"></div>`;
            
            let playTimeout = null;

            const startPlaybackLoop = () => {
                if (video.readyState < 2 || video.duration <= 10) return;
                const playRandomSegment = () => {
                    const maxStartTime = Math.max(0, video.duration - 5);
                    const startTime = Math.random() * maxStartTime;
                    video.currentTime = startTime;
                    video.play().catch(e => {});
                    playTimeout = setTimeout(playRandomSegment, 5000);
                };
                playRandomSegment();
            };
            
            const stopPlaybackLoop = () => {
                clearTimeout(playTimeout);
                video.pause();
                video.currentTime = randomThumbnailTime;
            };

            video.addEventListener('error', () => {
                cardWrapper.style.aspectRatio = '16 / 9';
                // --- التحسين الجديد: إضافة زر الفتح المباشر ---
                const fallbackButton = `
                    <div class="text-center">
                        <p class="text-xs text-red-400 mb-2">فشل التحميل (المصدر يمنع العرض)</p>
                        <a href="${url}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()"
                           class="inline-block bg-white text-black text-sm font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-300">
                           فتح الفيديو
                        </a>
                    </div>
                `;
                feedbackContainer.innerHTML = fallbackButton;
                cardWrapper.classList.remove('group'); // إزالة تأثيرات التمرير
            });

            video.addEventListener('loadedmetadata', () => {
                if (video.videoWidth > 0 && video.videoHeight > 0) {
                    cardWrapper.style.aspectRatio = `${video.videoWidth} / ${video.videoHeight}`;
                }
                feedbackContainer.style.display = 'none';
                video.classList.remove('opacity-0');

                cardWrapper.addEventListener('mouseenter', startPlaybackLoop);
                cardWrapper.addEventListener('mouseleave', stopPlaybackLoop);
            });

            cardWrapper.appendChild(feedbackContainer);
            cardWrapper.appendChild(video);
            
            return cardWrapper;
        }
        
        fetchAndInitialize();
    });
    </script>
</body>
</html>
